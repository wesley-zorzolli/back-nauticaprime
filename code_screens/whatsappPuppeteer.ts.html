<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>whatsappPuppeteer.ts</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" />
  <style>
    body{ background:#2b2b2b; color:#f8f8f2; font-family: 'Fira Code', monospace; padding:24px; }
    pre { font-size:14px; line-height:1.4; padding:20px; border-radius:8px; overflow:auto; }
    h1{ font-size:18px; color:#fff; margin-bottom:12px }
    .meta{ color:#bfbfbf; font-size:13px; margin-bottom:8px }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
</head>
<body>
  <h1>whatsappPuppeteer.ts</h1>
  <div class="meta">path: C:\Users\wesle\OneDrive\Área de Trabalho\nautica_prime\back_nautica\services\whatsappPuppeteer.ts</div>
  <pre class="language-javascript"><code>import http from 'http'
import path from 'path'
import puppeteer from 'puppeteer-core'

function getRemoteDebugUrl(): Promise&lt;string | null&gt; {
  const host = process.env.REMOTE_DEBUGGING_HOST || '127.0.0.1'
  const port = process.env.REMOTE_DEBUGGING_PORT || '9222'
  const url = `http://${host}:${port}/json/version`
  return new Promise((resolve) =&gt; {
    try {
      http.get(url, (res) =&gt; {
        let d = ''
        res.on('data', c =&gt; d += c)
        res.on('end', () =&gt; {
          try {
            const j = JSON.parse(d)
            return resolve(j.webSocketDebuggerUrl || null)
          } catch (e) {
            return resolve(null)
          }
        })
      }).on('error', () =&gt; resolve(null))
    } catch (e) {
      resolve(null)
    }
  })
}

export async function sendWhatsAppPuppeteer(toPhone: string, body: string) {
  if (!toPhone) throw new Error('toPhone é obrigatório')
  const digits = toPhone.replace(/\D/g, '')
  const withDDI = digits.startsWith('55') ? digits : `55${digits}`
  const phone = withDDI

  // tenta obter endpoint remoto (Chrome aberto com --remote-debugging-port)
  const ws = await getRemoteDebugUrl()

  // se não houver endpoint remoto, lança um erro (podemos no futuro tentar baixar chrome-headless-shell)
  if (!ws) throw new Error('Chrome remoto não encontrado em REMOTE_DEBUGGING_HOST/PORT')

  const browser = await puppeteer.connect({ browserWSEndpoint: ws, defaultViewport: null })
  try {
    const page = await browser.newPage()
    const encoded = encodeURIComponent(body)
    const url = `https://web.whatsapp.com/send?phone=${phone}&amp;text=${encoded}`
    await page.goto(url, { waitUntil: 'networkidle2', timeout: 120000 })

    // tenta detectar campo editável ou botão de enviar e enviar a mensagem
    const editableSelectors = [ 'div[contenteditable="true"][data-tab]', 'div[contenteditable="true"]' ]
    let editableFound: string | null = null
    for (const sel of editableSelectors) {
      try {
        await page.waitForSelector(sel, { timeout: 45000 })
        editableFound = sel
        break
      } catch (e) {}
    }

    if (editableFound) {
      await page.click(editableFound)
      // Se o texto já vier pré-preenchido pela query string, apenas espera e pressiona Enter
      // caso contrário digita e envia
      try {
        // se existir um botão de enviar, preferimos clicar
        const sendBtn = await page.$('button[data-testid="compose-btn-send"]')
        if (sendBtn) {
          await sendBtn.click()
          await page.waitForTimeout(500)
          return
        }
      } catch (e) {}

      // fallback: Press Enter
      await page.keyboard.press('Enter')
      await page.waitForTimeout(500)
      return
    }

    // se não encontrou campo editável, tenta clicar no botão de enviar
    const sendBtnSelectors = [ 'button[data-testid="compose-btn-send"]', 'button[aria-label="Enviar"]', 'button[title="Enviar"]' ]
    for (const btn of sendBtnSelectors) {
      try {
        await page.waitForSelector(btn, { timeout: 5000 })
        await page.click(btn)
        await page.waitForTimeout(500)
        return
      } catch (e) {}
    }

    throw new Error('Não foi possível enviar mensagem via Puppeteer: elementos não encontrados')
  } finally {
    try { await browser.disconnect() } catch (e) {}
  }
}

export default sendWhatsAppPuppeteer
</code></pre>
</body>
</html>